  parameters:
  - name: variableGroupName
    type: string

  - name: appName 
    type: string
    
  - name: resourceLocation 
    type: string
  
  - name: env 
    type: string
    values:
    - dev
    - tst
    - uat
    - prd
  
  - name: envFullName 
    type: string
    values:
    - Development
    - Test
    - UAT
    - Production

  jobs:
  - deployment: DeployTo${{ parameters.env }}
    environment: '${{ parameters.envFullName }}'
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      - group: ${{ parameters.variableGroupName }}
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          
          #Download the artifacts created in build stage
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)'

          #Create Infrastructure dependencies required
          - task: AzureResourceManagerTemplateDeployment@3
            displayName: 'Provision Azure Resources'
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: '$(ServiceConnection)'
              subscriptionId: '$(SubscriptionId)'
              resourceGroupName: '$(ResourceGroupName)'
              location: '${{parameters.resourceLocation}}'
              templateLocation: 'Linked artifact'
              csmFile: '$(System.ArtifactsDirectory)/drop/deploy/azuredeploy.bicep'
              csmParametersFile: '$(System.ArtifactsDirectory)/drop/deploy/azuredeploy.parameters.${{ parameters.env }}.json'
              overrideParameters: '-resourceGroupName "$(ResourceGroupName)"'
              deploymentMode: 'Incremental'

          #Deploy .Net code to Azure Web app
          - task: AzureWebApp@1
            displayName: 'Deploy ${{ parameters.appName }} to Azure Web app'
            inputs:
              azureSubscription: '${{ parameters.subscriptionId }}'
              appType: 'webAppLinux'
              appName: 'sample-web-${{ parameters.env }}'
              package: '$(System.DefaultWorkingDirectory)/**/*.zip'
              runtimeStack: 'DOTNETCORE|6.0'
